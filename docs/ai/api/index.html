<!DOCTYPE html>
<html lang="en">
    <head>
            <meta charset="utf-8">
            <meta http-equiv="X-UA-Compatible" content="IE=edge">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <meta content="Bmob,BmobCloud,bomb,BaaS,mBaaS,PaaS,Serverless,FaaS,Function as a Service,Backend as a Service,serverless computing,cloud function,后端云,bmob后端云,小程序云,小程序后端,云数据库,云存储,文件存储,云函数,云端代码,定时任务,游戏后端,游戏云,用户系统,无服务器函数,移动开发,app开发,小程序开发,云端一体化,互联网中间件" name="keywords"/>
            <meta content="国内首家专注于移动应用Serverless云服务的平台,Bmob后端云让移动开发更简单,全方位一体化的后端服务平台" name="description"/>
            
            
            
            <link rel="shortcut icon" href="../../img/favicon.ico">

        <script type="text/javascript" src="//game.bmobapp.com/static/doc_union.js"></script>
            <!--
            <title>API - Bmob文档中心</title>
            -->
            <title>Bmob后端云 </title>  
            
            <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
            <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
            <link href="../../css/base.css" rel="stylesheet">
            <link rel="stylesheet" href="../../css/highlight.css">
            <link href="../../css/agate.css" rel="stylesheet">
            <link href="../../css/custom.css" rel="stylesheet" id="custom">
    </head>

    <body >

        <div class="navbar navbar-fixed-top" role="navigation">
    <div class="main-nav">
        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <a class="navbar-brand" href="../..">
                <!--Bmob文档中心-->
                <img src="../../img/logo.png" alt="">
            </a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">

          <ul class="nav navbar-nav">
            
              <li class="pull-left">
                
					<a href="../..">文档首页</a>
                
              </li>
            
              <li class="pull-left">
                
					<!--<a href="">数据服务</a>-->
					<li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">数据服务 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
								<li >
									<a href="../../data/android/">Android</a>
                                </li>
                            
                            
								<li >
									<a href="../../data/ios/">iOS</a>
                                </li>
                            
                            
								<li >
									<a href="../../data/csharp/">C#</a>
                                </li>
                            
                            
								<li >
									<a href="../../data/php/">PHP</a>
                                </li>
                            
                            
								<li >
									<a href="../../data/go/">GO</a>
                                </li>
                            
                            
								<li >
									<a href="../../data/restful/">REST API</a>
                                </li>
                            
                            
								<li >
									<a href="../../data/wechat_app_new/rm/">JavaScript</a>
                                </li>
                            
                            
                                <li >
                                    <a href="../../data/cocos2d_x/">Cocos2D-X</a>
                                </li>
							
                            
                                <li >
                                    <a href="../../data/wechat_app_new/">快应用</a>
                                </li>
							
                            
                                <li >
                                    <a href="../../data/wechat_app_new/">Nodejs</a>
                                </li>
							
                            
                                <li >
                                    <a href="../../data/wechat_app_new/">Cocos Creator</a>
                                </li>
							
                            
								<li >
									<a href="../../data/wechat_app_new/rm/">小程序</a>
                                </li>
                            
                            
                                <li >
                                    <a href="../../data/kotlin/">Kotlin</a>
                                </li>
							
                            
                                <li >
                                    <a href="../../data/python/">Python</a>
                                </li>
							
                            
                                <li >
                                    <a href="../../data/flutter/">Flutter</a>
                                </li>
							
                        </ul>
                    </li>
                
              </li>
            
              <li class="pull-left">
                
					<!--<a href="../../cloud_function/android/">云函数</a>-->
					<li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">云函数 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
                                <li >
                                    <a href="../../cloud_function/android/">Android</a>
                                </li>
							
                            
                                <li >
                                    <a href="../../cloud_function/ios/">iOS</a>
                                </li>
							
                            
                                <li >
                                    <a href="../../cloud_function/java/">Java</a>
                                </li>
							
                            
                                <li >
                                    <a href="../../cloud_function/python/">Python</a>
                                </li>
							
                            
                                <li >
                                    <a href="../../cloud_function/csharp/">C#</a>
                                </li>
							
                            
                                <li >
                                    <a href="../../cloud_function/php/">PHP</a>
                                </li>
							
                            
                                <li >
                                    <a href="../../cloud_function/javascript/">JavaScript</a>
                                </li>
							
                            
                                <li >
                                    <a href="../../cloud_function/restful/">REST API</a>
                                </li>
							
                            
								<li >
									<a href="../../cloud_function/web/">Web</a>
                                </li>
                            
                        </ul>
                    </li>
                
              </li>
            
              <li class="pull-left">
                
					<!--<a href="../../sms/android/">短信服务</a>-->
					<li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">短信服务 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
                                <li >
                                    <a href="../../sms/android/">Android</a>
                                </li>
							
                            
                                <li >
                                    <a href="../../sms/ios/">iOS</a>
                                </li>
							
                            
                                <li >
                                    <a href="../../sms/php/">PHP</a>
                                </li>
							
                            
                                <li >
                                    <a href="../../sms/javascript/">JavaScript</a>
                                </li>
							
                            
                                <li >
                                    <a href="../../sms/restful/">REST API</a>
                                </li>
							
                            
                                <li >
                                    <a href="../../sms/python/">python</a>
                                </li>
							
                        </ul>
                    </li>
                
              </li>
            
              <li class="pull-left active">
                
					<!--<a href="../android/">AI人工智能</a>-->
					<li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">AI人工智能 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
                                <li >
                                    <a href="../android/">Android</a>
                                </li>
							
                            
                                <li >
                                    <a href="../ios/">iOS</a>
                                </li>
							
                            
                                <li >
                                    <a href="../html5/">小程序</a>
                                </li>
							
                            
                                <li >
                                    <a href="../html5/">Html5</a>
                                </li>
							
                            
                                <li class="active">
                                    <a href="./">API</a>
                                </li>
							
                            
                                <li >
                                    <a href="../python/">python</a>
                                </li>
							
                        </ul>
                    </li>
                
              </li>
            
              <li class="pull-left">
                
					<!--<a href="../../other/domain/">其他</a>-->
					<li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">其他 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
                                <li >
                                    <a href="../../other/domain/">域名管理</a>
                                </li>
							
                            
                                <li >
                                    <a href="../../other/common_problem/">常见问题</a>
                                </li>
							
                            
                                <li >
                                    <a href="../../other/error_code/">错误码</a>
                                </li>
							
                            
                                <li >
                                    <a href="../../other/data_safety/">数据安全</a>
                                </li>
							
                            
                                <li >
                                    <a href="../../other/bql/">BQL</a>
                                </li>
							
                        </ul>
                    </li>
                
              </li>
            
              <li>
                  <a href="https://www.bmobapp.com/repository/index" target="_blank">知识库</a>
              </li>
              <li>
                  <a href="http://doc.bmobapp.com/video/index.html" target="_blank">视频教程</a>
              </li>
            </ul>

        </div>
    </div>
</div>

        <div class="pagebody" id="main-wrapper">
            <div class="sidebar">
                <div class="bs-sidebar hidden-print affix well" role="complementary">

	
		
	
		
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
		
	
		
				
				
				
				
				
				
				
				
				
		
	
		
				
				
				
				
				
				
		
	
		
				
				
				
				
				
					<div class="code-title">API</div>
				
				
		
	
		
				
				
				
				
				
		
	


	<ul class="nav bs-sidenav">
		
			
		
			
		
			
		
			
		
			
				
					
						
					
						
					
						
					
						
					
						
							
								
									
										<li class="active "><a href="#_1">技术方案</a>
											
										</li>
									
										<li class=""><a href="#websocket">连接WebSocket服务器</a>
											
										</li>
									
										<li class=""><a href="#_2">发送对话消息</a>
											
										</li>
									
										<li class=""><a href="#ai">接收AI回复信息</a>
											
										</li>
									
										<li class=""><a href="#_3">保持心跳连接</a>
											
											<ul class="nav nav-l2">
												<li><a class="itm-l2" href="#ping">Ping</a></li>
											</ul>
											
											<ul class="nav nav-l2">
												<li><a class="itm-l2" href="#pong">Pong</a></li>
											</ul>
											
										</li>
									
								
							
						
					
						
					
				
			
		
			
		
	</ul>
</div>
            </div>
            <div class="content" role="main">
                <div class="wrap">
                    

<h2 id="_1">技术方案<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>Bmob AI为了兼容国内所有的平台，抛弃了Chatgpt采用的EventSource协议方案，仍然采用传统的WebSocket协议进行网络数据的实时传输。</p>
<p><code>WebSocket</code>和<code>EventSource</code>协议的优劣势及Bmob采用WebSocket协议的具体原因大家可以查看技术文档：<a href="https://juejin.cn/post/7256975111563214905">为什么建议国内的AI对话服务不采用EventSource协议？</a>。</p>
<p>接下来的文档按WebSocket通讯的几个环节进行：  </p>
<ul>
<li>连接WebSocket服务器</li>
<li>发送对话信息</li>
<li>接收AI回复信息</li>
<li>保持心跳连接</li>
</ul>
<h2 id="websocket">连接WebSocket服务器<a class="headerlink" href="#websocket" title="Permanent link">&para;</a></h2>
<p>WebSocket服务器的连接地址是：<code>wss://api.codenow.cn/1/ai/&lt;secret key&gt;</code></p>
<p>这里需要注意的地方是：  </p>
<ul>
<li>请求协议是<code>wss</code>安全协议</li>
<li>如果你有自己的备案域名，建议将 <code>api.codenow.cn</code> 域名变更为你自己的api备案域名。 </li>
<li><code>&lt;secret key&gt;</code> 要替换为你在控制台中创建的应用的<code>Secret Key</code>，如下图：</li>
</ul>
<p><img alt="" src="./image/secretkey.png" /></p>
<h2 id="_2">发送对话消息<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>连接成功之后，即可发送对话消息。</p>
<p>对话消息的格式为<code>json</code>格式，样例如下：</p>
<pre><code>{
    &quot;messages&quot;:
        [
            {&quot;content&quot;:&quot;接下来的每一个回复，你都要叫我宝贝&quot;,&quot;role&quot;:&quot;system&quot;},
            {&quot;content&quot;:&quot;你好&quot;,&quot;role&quot;:&quot;user&quot;},
            {&quot;content&quot;:&quot;你好宝贝！今天过得怎么样？有什么开心的事情要和我分享吗？&quot;,&quot;role&quot;:&quot;assistant&quot;},
            {&quot;content&quot;:&quot;没有&quot;,&quot;role&quot;:&quot;user&quot;}
        ],
    &quot;session&quot;:&quot;test_user&quot;
}
</code></pre>

<p>其中，<code>messages</code>是聊天的上下文信息，<code>content</code>是内容，<code>role</code>是角色。角色包含三种：</p>
<ul>
<li><code>system</code> 系统角色，通常放在messages对话数组的第一个位置，也就是我们常说的<code>prompt</code>。</li>
<li><code>user</code> 提问者角色。</li>
<li><code>assistant</code> 回答者角色，也就是chatgpt的回复内容。</li>
</ul>
<p><code>session</code>为会话标记，它的值你可以自定义，通常设定为用户的标记信息，如用户id或者手机号之类的。</p>
<p>你可以<code>不包含</code>prompt信息，这样的话，发送聊天的第一句的<code>json</code>消息就非常简单，样例如下：</p>
<pre><code>{
    &quot;messages&quot;:
        [
            {&quot;content&quot;:&quot;你好&quot;,&quot;role&quot;:&quot;user&quot;}
        ],
    &quot;session&quot;:&quot;test_user&quot;
}
</code></pre>

<h2 id="ai">接收AI回复信息<a class="headerlink" href="#ai" title="Permanent link">&para;</a></h2>
<p>发送对话信息之后，很快就会收到AI的回复信息。AI的回复信息是以流的形式，持续不断地发回对话结果。</p>
<p>接收到的回复信息一般如下，其中，<code>content</code>为回复的内容：</p>
<pre><code>{&quot;id&quot;:&quot;chatcmpl-7eb5Y7f5bRmIKZmqo1PHX5BmHR6VP&quot;,&quot;object&quot;:&quot;chat.completion.chunk&quot;,&quot;created&quot;:1689910044,&quot;model&quot;:&quot;gpt-3.5-turbo-0613&quot;,&quot;choices&quot;:[{&quot;delta&quot;:{&quot;role&quot;:&quot;&quot;,&quot;content&quot;:&quot;亲&quot;},&quot;index&quot;:0,&quot;finish_reason&quot;:&quot;&quot;}]}
</code></pre>

<p>当输出结束的时候，会收到如下的json包，即<code>finish_reason</code>的值标记为<code>stop</code>：</p>
<pre><code>{&quot;id&quot;:&quot;chatcmpl-7eb5Y7f5bRmIKZmqo1PHX5BmHR6VP&quot;,&quot;object&quot;:&quot;chat.completion.chunk&quot;,&quot;created&quot;:1689910044,&quot;model&quot;:&quot;gpt-3.5-turbo-0613&quot;,&quot;choices&quot;:[{&quot;delta&quot;:{&quot;role&quot;:&quot;&quot;,&quot;content&quot;:&quot;&quot;},&quot;index&quot;:0,&quot;finish_reason&quot;:&quot;stop&quot;}]}
</code></pre>

<h2 id="_3">保持心跳连接<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>为确保数据双通道通讯，你还需要和Bmob的AI服务器保持心跳连接，也就是俗称的<code>ping pong</code>。</p>
<h3 id="ping">Ping<a class="headerlink" href="#ping" title="Permanent link">&para;</a></h3>
<p>建议30秒发送一个<code>ping</code>字符串到WebSocket上面。</p>
<h3 id="pong">Pong<a class="headerlink" href="#pong" title="Permanent link">&para;</a></h3>
<p>服务器收到ping包之后，会回复一个<code>json</code>格式的pong出来，格式如下：</p>
<pre><code>{&quot;success&quot;:&quot;ok&quot;}
</code></pre>
                </div>
            </div>
        </div>

        
            <script>var base_url = '../..';</script>
            <script src="../../js/jquery-1.10.2.min.js"></script>
            <script src="../../js/bootstrap-3.0.3.min.js"></script>
            <script src="../../js/highlight.pack.js"></script>
            <script src="../../js/main.js"></script>
            <script src="../../js/base.js"></script>

		<!--
        <div id="go-top"><i class="fa fa-chevron-up"></i></div>
        <a href="https://docs.bmobapp.com/data/Android/a_faststart/doc/index.html" id="back" target="_blank">返回 <br> 旧版</a>
		-->
    </body>

</html>